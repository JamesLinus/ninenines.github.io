<tt>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;We&nbsp;have&nbsp;been&nbsp;using&nbsp;spawn_linked&nbsp;workers&nbsp;to&nbsp;handle&nbsp;tasks&nbsp;that&nbsp;live&nbsp;for&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;a&nbsp;single&nbsp;HTTP&nbsp;request&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;Although&nbsp;in&nbsp;the&nbsp;cowboy&nbsp;guide&nbsp;it&nbsp;is&nbsp;clear&nbsp;that&nbsp;Cowboy&nbsp;can&nbsp;use&nbsp;&quot;One&nbsp;Process&nbsp;of&nbsp;Many&nbsp;Requests&quot;&nbsp;I&nbsp;am&nbsp;surprised&nbsp;that&nbsp;this&nbsp;is&nbsp;the&nbsp;case&nbsp;even&nbsp;if&nbsp;the&nbsp;handler&nbsp;crashes.&nbsp;&nbsp;For&nbsp;example,&nbsp;our&nbsp;use&nbsp;case&nbsp;is&nbsp;to&nbsp;copy&nbsp;a&nbsp;large&nbsp;file&nbsp;to&nbsp;the&nbsp;server&nbsp;over&nbsp;HTTP&nbsp;where&nbsp;a&nbsp;worker&nbsp;process&nbsp;relays&nbsp;the&nbsp;file&nbsp;contents&nbsp;to&nbsp;long&nbsp;term&nbsp;storage.&nbsp;&nbsp;The&nbsp;worker&nbsp;process&nbsp;is&nbsp;spawn_linked&nbsp;from&nbsp;the&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;(for&nbsp;our&nbsp;use&nbsp;case)&nbsp;should&nbsp;die&nbsp;if&nbsp;the&nbsp;handler&nbsp;stops.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;If&nbsp;the&nbsp;client&nbsp;stops&nbsp;the&nbsp;upload&nbsp;(for&nbsp;example&nbsp;by&nbsp;browsing&nbsp;away,&nbsp;or&nbsp;losing&nbsp;connectivity)&nbsp;we&nbsp;correctly&nbsp;receive&nbsp;an&nbsp;error&nbsp;(see&nbsp;sample&nbsp;Lager&nbsp;trace&nbsp;below),&nbsp;but&nbsp;what&nbsp;we&nbsp;are&nbsp;seeing&nbsp;is&nbsp;that&nbsp;spawn_linked&nbsp;processes&nbsp;are&nbsp;NOT&nbsp;being&nbsp;killed.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;Is&nbsp;this&nbsp;intended&nbsp;behaviour&nbsp;-&nbsp;I&nbsp;accept&nbsp;it&nbsp;makes&nbsp;sense&nbsp;to&nbsp;reuse&nbsp;the&nbsp;processes&nbsp;but&nbsp;should&nbsp;this&nbsp;continue&nbsp;to&nbsp;be&nbsp;the&nbsp;case&nbsp;even&nbsp;if&nbsp;the&nbsp;previous&nbsp;use&nbsp;of&nbsp;the&nbsp;process&nbsp;crashed?&nbsp;&nbsp;If&nbsp;it&nbsp;is&nbsp;intended&nbsp;behaviour&nbsp;I&nbsp;think&nbsp;the&nbsp;docs&nbsp;should&nbsp;highlight&nbsp;this&nbsp;as&nbsp;we've&nbsp;been&nbsp;leaking&nbsp;processes&nbsp;for&nbsp;some&nbsp;time&nbsp;now,&nbsp;but&nbsp;I've&nbsp;always&nbsp;seen&nbsp;it&nbsp;as&nbsp;erlang's&nbsp;job&nbsp;to&nbsp;look&nbsp;after&nbsp;related&nbsp;process&nbsp;trees&nbsp;in&nbsp;the&nbsp;event&nbsp;of&nbsp;error.&nbsp;&nbsp;Our&nbsp;current&nbsp;workaround&nbsp;is&nbsp;to&nbsp;hold&nbsp;a&nbsp;list&nbsp;of&nbsp;linked&nbsp;processes&nbsp;in&nbsp;process&nbsp;storage&nbsp;and&nbsp;then&nbsp;kill&nbsp;them&nbsp;in&nbsp;the&nbsp;terminate&nbsp;handler&nbsp;which&nbsp;is&nbsp;ugly&nbsp;in&nbsp;the&nbsp;extreme!!&nbsp;&nbsp;We&nbsp;don't&nbsp;know&nbsp;the&nbsp;PIDS&nbsp;of&nbsp;the&nbsp;linked&nbsp;processes&nbsp;until&nbsp;it&nbsp;is&nbsp;too&nbsp;late&nbsp;to&nbsp;return&nbsp;State&nbsp;to&nbsp;Cowboy&nbsp;(i.e.&nbsp;we&nbsp;are&nbsp;already&nbsp;in&nbsp;our&nbsp;handle&nbsp;code)...&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;Kind&nbsp;regards&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12px;&quot;&gt;Adrian&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;16:09:32.347&nbsp;[info]&nbsp;Trailer&nbsp;upload&nbsp;failed&nbsp;with&nbsp;reason&nbsp;{case_clause,{error,closed}}&lt;/div&gt;&lt;div&gt;16:09:32.348&nbsp;[error]&nbsp;**&nbsp;Cowboy&nbsp;handler&nbsp;upload_trailer_resource&nbsp;terminating&nbsp;in&nbsp;handle/2&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;for&nbsp;the&nbsp;reason&nbsp;error:{case_clause,{error,closed}}&lt;/div&gt;&lt;div&gt;**&nbsp;Handler&nbsp;state&nbsp;was&nbsp;{state,undefined,0,undefined,undefined,undefined}&lt;/div&gt;&lt;div&gt;**&nbsp;Request&nbsp;was&nbsp;[{socket,#Port&lt;0.11230&gt;},{transport,ranch_tcp},{connection,keepalive},{pid,&lt;0.1987.0&gt;},{method,&lt;&lt;&quot;POST&quot;&gt;&gt;},{version,'HTTP/1.1'},{peer,{{84,92,32,116},64136}},{host,&lt;&lt;&quot;54.225.117.108&quot;&gt;&gt;},{host_info,undefined},{port,8000},{path,&lt;&lt;&quot;/upload_trailer&quot;&gt;&gt;},{path_info,undef&lt;/div&gt;&lt;div&gt;ined},{qs,&lt;&lt;&quot;name=linux-7.4.21.zip&amp;size=54015414&quot;&gt;&gt;},{qs_vals,undefined},{bindings,[]},{headers,[{&lt;&lt;&quot;host&quot;&gt;&gt;,&lt;&lt;&quot;54.225.117.108:8000&quot;&gt;&gt;},{&lt;&lt;&quot;connection&quot;&gt;&gt;,&lt;&lt;&quot;keep-alive&quot;&gt;&gt;},{&lt;&lt;&quot;content-length&quot;&gt;&gt;,&lt;&lt;&quot;54015414&quot;&gt;&gt;},{&lt;&lt;&quot;origin&quot;&gt;&gt;,&lt;&lt;&quot;http://54.225.117.108:8000&quot;&gt;&gt;},{&lt;&lt;&quot;user-agent&quot;&gt;&gt;,&lt;&lt;&quot;M&lt;/div&gt;&lt;div&gt;ozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10_8_4)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/28.0.1500.71&nbsp;Safari/537.36&quot;&gt;&gt;},{&lt;&lt;&quot;content-type&quot;&gt;&gt;,&lt;&lt;&gt;&gt;},{&lt;&lt;&quot;accept&quot;&gt;&gt;,&lt;&lt;&quot;*/*&quot;&gt;&gt;},{&lt;&lt;&quot;referer&quot;&gt;&gt;,&lt;&lt;&quot;http://54.225.117.108:8000/&quot;&gt;&gt;},{&lt;&lt;&quot;accept-encoding&quot;&gt;&gt;,&lt;&lt;&quot;gzip,deflate,sdch&quot;&gt;&gt;},{&lt;&lt;&quot;acce&lt;/div&gt;&lt;div&gt;pt-language&quot;&gt;&gt;,&lt;&lt;&quot;en-US,en;q=0.8&quot;&gt;&gt;},{&lt;&lt;&quot;cookie&quot;&gt;&gt;,&lt;&lt;&quot;__jwpusr=cbc133d7-1b49-443c-8a13-364660cc93e5;&nbsp;id3as_manager=f4803c004d71dde3b64394f6e6f44faa54970e93&quot;&gt;&gt;}]},{p_headers,[{&lt;&lt;&quot;connection&quot;&gt;&gt;,[&lt;&lt;&quot;keep-alive&quot;&gt;&gt;]}]},{cookies,undefined},{meta,[]},{body_state,waiting},{multipart,unde&lt;/div&gt;&lt;div&gt;fined},{buffer,&lt;&lt;&gt;&gt;},{resp_compress,true},{resp_state,waiting},{resp_headers,[]},{resp_body,&lt;&lt;&gt;&gt;},{onresponse,undefined}]&lt;/div&gt;&lt;div&gt;**&nbsp;Stacktrace:&nbsp;[{i_cowboy,stream_body,0,[{file,&quot;src/i_cowboy.erl&quot;},{line,76}]},{upload_trailer_resource,stream_upload_file,4,[{file,&quot;src/endpoints/upload_trailer_resource.erl&quot;},{line,247}]},{upload_trailer_resource,upload_file,1,[{file,&quot;src/endpoints/upload_trailer_resource.erl&quot;}&lt;/div&gt;&lt;div&gt;,{line,237}]},{upload_trailer_resource,head_or_post,1,[{file,&quot;src/endpoints/upload_trailer_resource.erl&quot;},{line,202}]},{upload_trailer_resource,sequence,2,[{file,&quot;src/endpoints/upload_trailer_resource.erl&quot;},{line,106}]},{upload_trailer_resource,process_request,1,[{file,&quot;src/endpo&lt;/div&gt;&lt;div&gt;ints/upload_trailer_resource.erl&quot;},{line,212}]},{i_cowboy,do,3,[{file,&quot;src/i_cowboy.erl&quot;},{line,29}]},{cowboy_handler,handler_handle,4,[{file,&quot;src/cowboy_handler.erl&quot;},{line,119}]}]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&nbsp;&lt;/div&gt;&lt;div&gt;Dr&nbsp;Adrian&nbsp;Roe&lt;/div&gt;&lt;div&gt;Director&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</tt>
