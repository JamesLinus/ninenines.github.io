<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Nine Nines Support: Cowboy User Guide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Change them or set them up as you like -->
    <meta name="description" content="">
    <meta name="author" content="(Soft10) Pol Cámara">

    <!-- Stylesheets -->    
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/99s.css" rel="stylesheet">
<!--    <link href="js/google-code-prettify/prettify.css" rel="stylesheet"> -->
    <link href="/css/sh99s.css"  rel="stylesheet"/>

    <!-- Enables html5 support on older browsers, other js is placed at the end of the page to speed up loading -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/img/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/ico/apple-touch-icon-114.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/ico/apple-touch-icon-72.png">
    <link rel="apple-touch-icon-precomposed" href="/img/ico/apple-touch-icon-57.png">
	<link rel="alternate" href="/feeds/atom.xml" type="application/atom+xml" title="Nine Nines Atom Feed">
  </head>

  <body class="big_text docs">
    <header id="page-head">
      <div id="topbar" class="container">
          <div class="row">
            <div class="span2">
              <h1 id="logo"><a href="/" title="99s">99s</a></h1>
            </div>
            <div class="span10">
              <!-- Top navigation and social icons-->
              <div id="side-header">
                <nav>
                  <ul>
					<li><a title="Erlang training" href="/training">Training</a></li>
                    <li><a title="Technical publications" href="/articles">Articles</a></li>
					<li><a title="Our talks" href="/talks">Talks</a></li>
					<li class="active"><a title="Our services" href="/support">Pricing &amp; Sponsoring</a></li>
					<li><a title="Community support" href="http://lists.ninenines.eu">Mailing Lists</a></li>
                    <li><a title="Contact us" href="mailto:contact@ninenines.eu">Contact</a></li>
                  </ul>
                </nav> 
                <ul id="social">
                  <li>
                    <a href="https://github.com/ninenines" title="Check our Github repositories"><img src="/img/ico_github.png" data-hover="/img/ico_github_alt.png" alt="Github"></a>
                  </li>
                  <li class="dropdown" id="twitter-links">
                    <a href="#twitter-links" class="dropdown-toggle" data-toggle="dropdown"  title="Follow us on Twitter">
                        <img src="/img/ico_twitter.png" data-hover="/img/ico_twitter_alt.png" alt="Twitter">
                    </a>                 
                    <ul class="dropdown-menu">
                      <li><a title="Visit Loïc Hoguin's Twitter Account" href="http://twitter.com/lhoguin">@lhoguin</a></li>
                      <!-- <li class="divider"></li>
                      <li><a title="Visit our official Twitter account" href="#">@99s</a></li> -->
                    </ul>
                  </li>
                  <!-- <li>
                    <a href="/css/" title="Add us on Linkedin"><img src="/img/ico_linkedin.png" data-hover="img/ico_linkedin_alt.png" alt="Linkedin"></a>
                  </li> -->
                </ul>
              </div>
            </div>
          </div>
      </div>


    </header>


<div id="contents" class="two_col">
<div class="container">
<div class="row">
<div id="docs" class="span9 maincol">

<h1 class="lined-header"><span>The Req object</span></h1>

<p>The Req object is this variable that you will use to obtain information about a request, read the body of the request and send a response.</p>

<h2 id="a_special_variable">A special variable</h2>

<p>While we call it an "object", it is not an object in the OOP sense of the term. In fact it is completely opaque to you and the only way you can perform operations using it is by calling the functions from the <code>cowboy_req</code> module.</p>

<p>Almost all the calls to the <code>cowboy_req</code> module will return an updated request object. Just like you would keep the updated <code>State</code> variable in a gen_server, you MUST keep the updated <code>Req</code> variable in a Cowboy handler. Cowboy will use this object to know whether a response has been sent when the handler has finished executing.</p>

<p>The Req object allows accessing both immutable and mutable state. This means that calling some of the functions twice will not produce the same result. For example, when streaming the request body, the function will return the body by chunks, one at a time, until there is none left.</p>

<h2 id="overview_of_the_cowboy_req_interface">Overview of the cowboy_req interface</h2>

<p>With the exception of functions manipulating the request body, all functions return a single value. Depending on the function this can be the requested value (method, host, path, ...), a boolean (has_body, has_resp_header...) a new Req object (set_resp_body, set_resp_header...), or simply the atom <code>ok</code> (chunk, continue, ...).</p>

<p>The request body reading functions may return <code>{Result, Req}</code> or <code>{Result, Value, Req}</code>. The functions in this category are <code>body/{1,2}</code>, <code>body_qs/{1,2}</code>, <code>part/{1,2}</code>, <code>part_body/{1,2}</code>.</p>

<p>This chapter covers the access functions mainly. Cookies, request body and response functions are covered in their own chapters.</p>

<h2 id="request">Request</h2>

<p>When a client performs a request, it first sends a few required values. They are sent differently depending on the protocol being used, but the intent is the same. They indicate to the server the type of action it wants to do and how to locate the resource to perform it on.</p>

<p>The method identifies the action. Standard methods include GET, HEAD, OPTIONS, PATCH, POST, PUT, DELETE. Method names are case sensitive.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Method = cowboy_req:method(Req).
]]></script>

<p>The host, port and path parts of the URL identify the resource being accessed. The host and port information may not be available if the client uses HTTP/1.0.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Host = cowboy_req:host(Req),
Port = cowboy_req:port(Req),
Path = cowboy_req:path(Req).
]]></script>

<p>The version used by the client can of course also be obtained.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Version = cowboy_req:version(Req).
]]></script>

<p>Do note however that clients claiming to implement one version of the protocol does not mean they implement it fully, or even properly.</p>

<h2 id="bindings">Bindings</h2>

<p>After routing the request, bindings are available. Bindings are these parts of the host or path that you chose to extract when defining the routes of your application.</p>

<p>You can fetch a single binding. The value will be <code>undefined</code> if the binding doesn't exist.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Binding = cowboy_req:binding(my_binding, Req).
]]></script>

<p>If you need a different value when the binding doesn't exist, you can change the default.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Binding = cowboy_req:binding(my_binding, Req, 42).
]]></script>

<p>You can also obtain all bindings in one call. They will be returned as a list of key/value tuples.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
AllBindings = cowboy_req:bindings(Req).
]]></script>

<p>If you used <code>...</code> at the beginning of the route's pattern for the host, you can retrieve the matched part of the host. The value will be <code>undefined</code> otherwise.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
HostInfo = cowboy_req:host_info(Req).
]]></script>

<p>Similarly, if you used <code>...</code> at the end of the route's pattern for the path, you can retrieve the matched part, or get <code>undefined</code> otherwise.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
PathInfo = cowboy_req:path_info(Req).
]]></script>

<h2 id="query_string">Query string</h2>

<p>The raw query string can be obtained directly.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Qs = cowboy_req:qs(Req).
]]></script>

<p>You can parse the query string and then use standard library functions to access individual values.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
QsVals = cowboy_req:parse_qs(Req),
{_, Lang} = lists:keyfind(<<"lang">>, 1, QsVals).
]]></script>

<p>You can match the query string into a map.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
#{id := ID, lang := Lang} = cowboy_req:match_qs([id, lang], Req).
]]></script>

<p>You can use constraints to validate the values while matching them. The following snippet will crash if the <code>id</code> value is not an integer number or if the <code>lang</code> value is empty. Additionally the <code>id</code> value will be converted to an integer term, saving you a conversion step.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
QsMap = cowboy_req:match_qs([{id, int}, {lang, nonempty}], Req).
]]></script>

<p>Note that in the case of duplicate query string keys, the map value will become a list of the different values.</p>

<p>Read more about <a href="/docs/en/cowboy/HEAD/guide/constraints">constraints</a>.</p>

<p>A default value can be provided. The default will be used if the <code>lang</code> key is not found. It will not be used if the key is found but has an empty value.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
#{lang := Lang} = cowboy_req:match_qs([{lang, [], <<"en-US">>}], Req).
]]></script>

<p>If no default is provided and the value is missing, the query string is deemed invalid and the process will crash.</p>

<h2 id="request_url">Request URL</h2>

<p>You can reconstruct the full URL of the resource.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
URL = cowboy_req:url(Req).
]]></script>

<p>You can also obtain only the base of the URL, excluding the path and query string.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
BaseURL = cowboy_req:host_url(Req).
]]></script>

<h2 id="headers">Headers</h2>

<p>Cowboy allows you to obtain the header values as string, or parsed into a more meaningful representation.</p>

<p>This will get the string value of a header.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
HeaderVal = cowboy_req:header(<<"content-type">>, Req).
]]></script>

<p>You can of course set a default in case the header is missing.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
HeaderVal
    = cowboy_req:header(<<"content-type">>, Req, <<"text/plain">>).
]]></script>

<p>And also obtain all headers.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
AllHeaders = cowboy_req:headers(Req).
]]></script>

<p>To parse the previous header, simply call <code>parse_header/{2,3}</code> where you would call <code>header/{2,3}</code> otherwise.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
ParsedVal = cowboy_req:parse_header(<<"content-type">>, Req).
]]></script>

<p>Cowboy will crash if it doesn't know how to parse the given header, or if the value is invalid.</p>

<p>You can of course define a default value. Note that the default value you specify here is the parsed value you'd like to get by default.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
ParsedVal = cowboy_req:parse_header(<<"content-type">>, Req,
	{<<"text">>, <<"plain">>, []}).
]]></script>

<p>The list of known headers and default values is defined in the manual.</p>

<h2 id="meta">Meta</h2>

<p>Cowboy will sometimes associate some meta information with the request. Built-in meta values are listed in the manual for their respective modules.</p>

<p>This will get a meta value. The returned value will be <code>undefined</code> if it isn't defined.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
MetaVal = cowboy_req:meta(websocket_version, Req).
]]></script>

<p>You can change the default value if needed.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
MetaVal = cowboy_req:meta(websocket_version, Req, 13).
]]></script>

<p>You can also define your own meta values. The name must be an <code>atom()</code>.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
Req2 = cowboy_req:set_meta(the_answer, 42, Req).
]]></script>

<h2 id="peer">Peer</h2>

<p>You can obtain the peer address and port number. This is not necessarily the actual IP and port of the client, but rather the one of the machine that connected to the server.</p>

<script type="syntaxhighlighter" class="brush: erlang"><![CDATA[
{IP, Port} = cowboy_req:peer(Req).
]]></script>


<!-- a.code -->
</div>

<div class="span3 sidecol">
<div class="input-append">
<form id="form-search" class="form-search" action="#">
	<input id="input-search" type="text" placeholder="Function search" autocomplete="off" autofocus class="input-medium search-query span2">
	<button type="submit" class="btn btn-success">Go</button>
</form>
</div>

<h3 id="docs-nav">Navigation</h3>

<h3>See also</h3><ul><li><a href="/docs/en/cowboy/HEAD/manual/">Function Reference</a></li><li><a href="/docs/en/cowboy/HEAD/index.html">README</a></li></ul>

<h3>Version select</h3>
<ul>

	<li><a href="/docs/en/cowboy/1.0/guide/"><strong>1.0</strong></a></li>

	<li><a href="/docs/en/cowboy/HEAD/guide/"><strong>HEAD</strong></a></li>

</ul>

</div>
</div>
</div>
</div>


      <footer>
        <div class="container">
          <div class="row">
            <div class="span6">
              <p id="scroll-top"><a href="#">↑ Scroll to top</a></p>
              <nav>
                <ul>
                  <li><a href="mailto:contact@ninenines.eu" title="Contact us">Contact us</a></li><li><a href="https://github.com/ninenines/ninenines.github.io" title="Github repository">Contribute to this site</a></li>
                </ul>
              </nav>
            </div>
            <div class="span6 credits">
               <p><img src="/img/footer_logo.png"></p>
               <p>Copyright &copy; Nine Nines 2012-2014</p>
            </div>
          </div>
        </div>
      </footer>

    <!-- Javascript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/js/bootstrap-carousel.js"></script>
    <script src="/js/bootstrap-dropdown.js"></script>
    <script src="/js/custom.js"></script>


<script type="text/javascript" src="/js/shCore.js"></script>
<script type="text/javascript" src="/js/shlang/shBrushBash.js"></script>
<script type="text/javascript" src="/js/shlang/shBrushErlang.js"></script>
<script type="text/javascript" src="/js/shlang/shBrushJScript.js"></script>
<script type="text/javascript" src="/js/shlang/shBrushPlain.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();</script>

<script type="text/javascript" src="/js/fuse.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	var f;

	$.getJSON("/docs/db.json", function(data){
		f = new Fuse(data, {keys: ["n"], threshold: 0.3});
		$("<ul id=\"search-results\">").insertAfter("#form-search");
	});

	$("#input-search").keyup(function(e){if(f){if (e.which != 13 ){
		var results = f.search($(this).val());
		if (results.length == 0){
			$("#form-search").attr("action", "#");
		}else{
			$("#form-search").attr("action", results[0].l);
		}

		$("#search-results").empty();
		for (var i = 0; i < 10 && i < results.length; i++){
			$("<li><a href=\"" + results[i].l + "\">" + results[i].n + "</a></li>")
				.appendTo("#search-results");
		}
	}}});
});
</script>

  </body>
</html>
