<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Loïc Hoguin based on a design from (Soft10) Pol Cámara">

    <meta name="generator" content="Hugo 0.17" />

    <title>Nine Nines: Request overview</title>

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
	
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/99s.css" rel="stylesheet">

    <link rel="shortcut icon" href="/img/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/ico/apple-touch-icon-114.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/ico/apple-touch-icon-72.png">
    <link rel="apple-touch-icon-precomposed" href="/img/ico/apple-touch-icon-57.png">

    
</head>


<body class="">
  <header id="page-head">
    <div id="topbar" class="container">
        <div class="row">
          <div class="span2">
            <h1 id="logo"><a href="/" title="99s">99s</a></h1>
          </div>
          <div class="span10">
            
            <div id="side-header">
              <nav>
                <ul>
                  <li><a title="Hear my thoughts" href="/articles">Articles</a></li>
  				  <li><a title="Watch my talks" href="/talks">Talks</a></li>
  				  <li class="active"><a title="Read the docs" href="/docs">Documentation</a></li>
  				  <li><a title="Request my services" href="/services">Consulting & Training</a></li>
                </ul>
              </nav> 
              <ul id="social">
                <li>
                  <a href="https://github.com/ninenines" title="Check my Github repositories"><img src="/img/ico_github.png" data-hover="/img/ico_github_alt.png" alt="Github"></a>
                </li>
                    <li>
						<a title="Keep in touch!" href="http://twitter.com/lhoguin"><img src="/img/ico_microblog.png" data-hover="/img/ico_microblog_alt.png"></a>
					</li>
                    <li>
						<a title="Contact me" href="mailto:contact@ninenines.eu"><img src="/img/ico_mail.png" data-hover="/img/ico_mail_alt.png"></a>
					</li>
              </ul>
            </div>
          </div>
        </div>
    </div>


</header>

<div id="contents" class="two_col">
<div class="container">
<div class="row">
<div id="docs" class="span9 maincol">

<h1 class="lined-header"><span>Request overview</span></h1>

<div class="paragraph"><p>This chapter explains the different steps a request
goes through until a response is sent, along with
details of the Cowboy implementation.</p></div>
<div class="sect1">
<h2 id="_request_response">Request/response</h2>
<div class="sectionbody">
<div class="paragraph"><p>As you already know, HTTP clients connect to the server and
send a request for a resource; the server then sends a
response containing the resource if it could obtain it.</p></div>
<div class="paragraph"><p>Before the server can send the resource, however, it
needs to perform many different operations to read the
request, find the resource, prepare the response being
sent and often other related operations the user can
add like writing logs.</p></div>
<div class="paragraph"><p>Requests take the following route in Cowboy:</p></div>
<div class="imageblock">
<div class="content">
<img src="../http_req_resp.png" alt="HTTP request/response flowchart" />
</div>
</div>
<div class="paragraph"><p>This shows the default middlewares, but they may be
configured differently in your setup. The dark green
indicates the points where you can hook your own code,
the light green is the Cowboy code that you can of
course configure as needed.</p></div>
<div class="paragraph"><p>The <code>acceptor</code> is the part of the server that accepts
the connection and create an Erlang process to handle
it. The <code>parser</code> then starts reading from the socket
and handling requests as they come until the socket
is closed.</p></div>
<div class="paragraph"><p>A response may be sent at many different points in the
life of the request. If Cowboy can&#8217;t parse the request,
it gives up with an error response. If the router can&#8217;t
find the resource, it sends a not found error. Your
own code can of course send a response at any time.</p></div>
<div class="paragraph"><p>When a response is sent, you can optionally modify it
or act upon it by enabling the <code>onresponse</code> hook. By
default the response is sent directly to the client.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_and_then">And then?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Behavior depends on what protocol is in use.</p></div>
<div class="paragraph"><p>HTTP/1.0 can only process one request per connection,
so Cowboy will close the connection immediately after
it sends the response.</p></div>
<div class="paragraph"><p>HTTP/1.1 allows the client to request that the server
keeps the connection alive. This mechanism is described
in the next section.</p></div>
<div class="paragraph"><p>HTTP/2 is designed to allow sending multiple requests
asynchronously on the same connection. Details on what
this means for your application is described in this
chapter.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_keep_alive_http_1_1">Keep-alive (HTTP/1.1)</h2>
<div class="sectionbody">
<div class="paragraph"><p>With HTTP/1.1, the connection may be left open for
subsequent requests to come. This mechanism is called
<code>keep-alive</code>.</p></div>
<div class="paragraph"><p>When the client sends a request to the server, it includes
a header indicating whether it would like to leave the
socket open. The server may or may not accept, indicating
its choice by sending the same header in the response.</p></div>
<div class="paragraph"><p>Cowboy will include this header automatically in all
responses to HTTP/1.1 requests. You can however force
the closing of the socket if you want. When Cowboy sees
you want to send a <code>connection: close</code> header, it will
not override it and will close the connection as soon
as the reply is sent.</p></div>
<div class="paragraph"><p>This snippet will force Cowboy to close the connection.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">Req2</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">cowboy_req:reply</span></span>(<span style="color: #993399">200</span>, [
    {<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"connection"</span><span style="color: #990000">&gt;&gt;</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"close"</span><span style="color: #990000">&gt;&gt;</span>},
], <span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"Closing the socket in 3.. 2.. 1.."</span><span style="color: #990000">&gt;&gt;</span>, <span style="color: #009900">Req</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Cowboy will only accept a certain number of new requests
on the same connection. By default it will run up to 100
requests. This number can be changed by setting the
<code>max_keepalive</code> configuration value when starting an
HTTP listener.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">cowboy:start_http</span></span>(<span style="color: #FF6600">my_http_listener</span>, <span style="color: #993399">100</span>, [{<span style="color: #FF6600">port</span>, <span style="color: #993399">8080</span>}], [
        {<span style="color: #FF6600">env</span>, [{<span style="color: #FF6600">dispatch</span>, <span style="color: #009900">Dispatch</span>}]},
        {<span style="color: #FF6600">max_keepalive</span>, <span style="color: #993399">5</span>}
])<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Cowboy implements the keep-alive mechanism by reusing
the same process for all requests. This allows Cowboy
to save memory. This works well because most code will
not have any side effect impacting subsequent requests.
But it also means you need to clean up if you do have
code with side effects. The <code>terminate/3</code> function can
be used for this purpose.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_pipelining_http_1_1">Pipelining (HTTP/1.1)</h2>
<div class="sectionbody">
<div class="paragraph"><p>While HTTP is designed as a sequential protocol, with
the client sending a request and then waiting for the
response from the server, nothing prevents the client
from sending more requests to the server without waiting
for the response, due to how sockets work. The server
still handles the requests sequentially and sends the
responses in the same order.</p></div>
<div class="paragraph"><p>This mechanism is called pipelining. It allows reducing
latency when a client needs to request many resources
at the same time. This is used by browsers when requesting
static files for example.</p></div>
<div class="paragraph"><p>This is handled automatically by the server.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_asynchronous_requests_http_2">Asynchronous requests (HTTP/2)</h2>
<div class="sectionbody">
<div class="paragraph"><p>In HTTP/2, the client can send a request at any time.
And the server can send a response at any time too.</p></div>
<div class="paragraph"><p>This means for example that the client does not need
to wait for a request to be fully sent to send another,
it is possible to interleave a request with the request
body of another request. The same is true with responses.
Responses may also be sent in a different order.</p></div>
<div class="paragraph"><p>Because requests and responses are fully asynchronous,
Cowboy creates a new process for each request, and these
processes are managed by another process that handles the
connection itself.</p></div>
<div class="paragraph"><p>HTTP/2 servers may also decide to send resources to the
client before the client requests them. This is especially
useful for sending static files associated with the HTML
page requested, as this reduces the latency of the overall
response. Cowboy does not support this particular mechanism
at this point, however.</p></div>
</div>
</div>





</div>

<div class="span3 sidecol">


<h3>
	Cowboy
	2.0
	
	User Guide
</h3>

<ul>
	
		<li><a href="/docs/en/cowboy/2.0/guide">User Guide</a></li>
	
	
		<li><a href="/docs/en/cowboy/2.0/manual">Function Reference</a></li>
	
	
</ul>

<h4 id="docs-nav">Navigation</h4>

<h4>Version select</h4>
<ul>
	
	
	
		<li><a href="/docs/en/cowboy/1.0/guide">1.0</a></li>
	
		<li><a href="/docs/en/cowboy/2.0/guide">2.0</a></li>
	
</ul>

</div>
</div>
</div>
</div>

      <footer>
        <div class="container">
          <div class="row">
            <div class="span6">
              <p id="scroll-top"><a href="#">↑ Scroll to top</a></p>
              <nav>
                <ul>
                  <li><a href="mailto:contact@ninenines.eu" title="Contact us">Contact us</a></li><li><a href="https://github.com/ninenines/ninenines.github.io" title="Github repository">Contribute to this site</a></li>
                </ul>
              </nav>
            </div>
            <div class="span6 credits">
               <p><img src="/img/footer_logo.png"></p>
               <p>Copyright &copy; Loïc Hoguin 2012-2016</p>
            </div>
          </div>
        </div>
      </footer>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/js/bootstrap-carousel.js"></script>
    <script src="/js/bootstrap-dropdown.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>


